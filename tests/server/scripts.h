#ifndef MOONSHINE_TESTS_SERVER_SCRIPTS_H_
#define MOONSHINE_TESTS_SERVER_SCRIPTS_H_

const std::string http_listener = R"(
local httpd = require "httpd"
local copas = require "copas"
local string = require "string"
local url = require "socket.url"
local mime = require "mime"
local listener = require "listener"
local messages = require "messages"

if #arg ~= 2 then
    error("Expecting 2 arguments, got " .. #arg)
end

local address = arg[1]
local port = arg[2]

local function parse_cookies(req, name)
    local cookies = req.headers["cookie"] or ""
    cookies = ";" .. cookies .. ";"
    cookies = string.gsub(cookies, "%s*;%s*", ";")   -- remove extra spaces
    local pattern = ";" .. name .. "=(.-);"
    local _, _, value = string.find(cookies, pattern)
    if value then
        value = url.unescape(value)
    end
    return value
end

local function handle_request(req, res)
    if req.cmd_mth == "GET" then
        if req.relpath == "/" then
            local metadata = parse_cookies(req, "implant")
            if metadata ~= nil and metadata ~= "" then
                metadata = mime.unb64(metadata)
                success, data = messages.retrieve(metadata)
                if success then
                    if data then
                        res.headers["Content-Type"] = "text/plain"
                        res.content = mime.b64(data)
                    end
                    return res
                end
            end
            return httpd.err_400(req, res)
        end
        return httpd.err_404(req, res)
    elseif req.cmd_mth == "POST" then
        if req.relpath == "/" then
            local metadata = parse_cookies(req, "implant")
            if metadata ~= nil and metadata ~= "" then
                metadata = mime.unb64(metadata)
                local data = ""
                if req.content then
                    data = mime.unb64(req.content)
                end
                if messages.submit(metadata, data) then
                    return res
                end
            end
            return httpd.err_400(req, res)
        end
        return httpd.err_404(req, res)
    end
    return httpd.err_405(req, res)
end

httpd.handle_request = handle_request
httpd.register(address, port, "Apache")

while listener.run() do
    copas.step(1)
end
)";

const std::string httpd = "LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KLS0gWGF2YW50ZSBIVFRQIGhhbmRsZXIKLS0KLS0gQXV0aG9yczogSmF2aWVyIEd1ZXJyYSBhbmQgQW5kcmUgQ2FycmVnYWwKLS0gQ29weXJpZ2h0IChjKSAyMDA0LTIwMDcgS2VwbGVyIFByb2plY3QKLS0KLS0gJElkOiBodHRwZC5sdWEsdiAxLjQ1IDIwMDkvMDgvMTAgMjA6MDA6NTkgbWFzY2FyZW5oYXMgRXhwICQKLS0KLS0gaHR0cHM6Ly9naXRodWIuY29tL2tlcGxlcnByb2plY3QveGF2YW50ZS9ibG9iL21hc3Rlci9zcmMveGF2YW50ZS9odHRwZC5sdWEKLS0KLS0gTW9kaWZpZWQgdG8gc3VwcG9ydCBQT1NUIHJlcXVlc3RzIGFuZCBvdGhlciB2YXJpb3VzIHNtYWxsIGNoYW5nZXMKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCmxvY2FsIHN0cmluZyA9IHJlcXVpcmUgInN0cmluZyIKbG9jYWwgdGFibGUgPSByZXF1aXJlICJ0YWJsZSIKbG9jYWwgb3MgPSByZXF1aXJlICJvcyIKCmxvY2FsIHNvY2tldCA9IHJlcXVpcmUgInNvY2tldCIKbG9jYWwgdXJsID0gcmVxdWlyZSAic29ja2V0LnVybCIKbG9jYWwgY29wYXMgPSByZXF1aXJlICJjb3BhcyIKCmxvY2FsIHVucGFjayA9IHRhYmxlLnVucGFjayBvciB1bnBhY2sKCmxvY2FsIF9NID0ge30KCmxvY2FsIF9zZXJ2ZXJzb2Z0d2FyZSA9ICIiCgpsb2NhbCBfc2VydmVycG9ydHMgPSB7fQpsb2NhbCBfc2VydmVyaXBzID0ge30KCmZ1bmN0aW9uIF9NLnN0cnNwbGl0IChzdHIpCiAgICBsb2NhbCB3b3JkcyA9IHt9CgogICAgZm9yIHcgaW4gc3RyaW5nLmdtYXRjaCAoc3RyLCAiJVMrIikgZG8KICAgICAgICB0YWJsZS5pbnNlcnQgKHdvcmRzLCB3KQogICAgZW5kCgogICAgcmV0dXJuIHdvcmRzCmVuZAoKCi0tIE1hbmFnZXMgb25lIGNvbm5lY3Rpb24sIG1heWJlIHNldmVyYWwgcmVxdWVzdHMKLS0gcGFyYW1zOgotLSAgICAgICAgICAgICAgc2t0IDogY2xpZW50IHNvY2tldAoKZnVuY3Rpb24gX00uY29ubmVjdGlvbiAoc2t0KQogICAgY29wYXMuc2V0RXJyb3JIYW5kbGVyIChfTS5lcnJvcmhhbmRsZXIpCgogICAgc2t0OnNldG9wdGlvbiAoInRjcC1ub2RlbGF5IiwgdHJ1ZSkKICAgIGxvY2FsIHNydiwgcG9ydCA9IHNrdDpnZXRzb2NrbmFtZSAoKQogICAgbG9jYWwgY2hvc3QsIGNwb3J0PSBza3Q6Z2V0cGVlcm5hbWUgKCkKICAgIGxvY2FsIHJlcSA9IHsKICAgICAgICByYXdza3QgPSBza3QsCiAgICAgICAgc3J2ID0gc3J2LAogICAgICAgIHBvcnQgPSBwb3J0LAogICAgICAgIGNob3N0ID0gY2hvc3QsCiAgICAgICAgY3BvcnQgPSBjcG9ydCwKICAgICAgICBjb3Bhc3NrdCA9IGNvcGFzLndyYXAgKHNrdCksCiAgICB9CiAgICByZXEuc29ja2V0ID0gcmVxLmNvcGFzc2t0CiAgICByZXEuc2VydmVyc29mdHdhcmUgPSBfc2VydmVyc29mdHdhcmUKCiAgICB3aGlsZSBfTS5yZWFkX21ldGhvZCAocmVxKSBkbwogICAgICAgIGxvY2FsIHJlcwogICAgICAgIF9NLnJlYWRfaGVhZGVycyAocmVxKQoKICAgICAgICBpZiByZXEuaGVhZGVyc1siY29udGVudC1sZW5ndGgiXSB0aGVuCiAgICAgICAgICAgIF9NLnJlYWRfY29udGVudChyZXEpCiAgICAgICAgZW5kCgogICAgICAgIHJlcGVhdAogICAgICAgICAgICByZXEucGFyYW1zID0gbmlsCiAgICAgICAgICAgIF9NLnBhcnNlX3VybCAocmVxKQogICAgICAgICAgICByZXMgPSBfTS5tYWtlX3Jlc3BvbnNlIChyZXEpCiAgICAgICAgdW50aWwgX00uaGFuZGxlX3JlcXVlc3QgKHJlcSwgcmVzKSB+PSAicmVwYXJzZSIKICAgICAgICBfTS5zZW5kX3Jlc3BvbnNlIChyZXEsIHJlcykKCiAgICAgICAgcmVxLnNvY2tldDpmbHVzaCAoKQogICAgICAgIGlmIG5vdCByZXMua2VlcF9hbGl2ZSB0aGVuCiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgZW5kCiAgICBlbmQKZW5kCgoKZnVuY3Rpb24gX00uZXJyb3JoYW5kbGVyIChtc2csIGNvLCBza3QpCiAgICBtc2cgPSB0b3N0cmluZyhtc2cpCiAgICBwcmludCgiRXJyb3I6ICIuLm1zZy4uIlxuIiwgIiAgIi4udG9zdHJpbmcoY28pLi4iXG4iLCAiICAiLi50b3N0cmluZyhza3QpLi4iXG4iKQogICAgc2t0OnNlbmQgKCJIVFRQLzEuMCA1MDAgSW50ZXJuYWwgU2VydmVyIEVycm9yXHJcbiIpCiAgICBza3Q6c2VuZCAoc3RyaW5nLmZvcm1hdCAoIkRhdGU6ICVzXHJcblxyXG4iLCBvcy5kYXRlICgiISVhLCAlZCAlYiAlWSAlSDolTTolUyBHTVQiKSkpCiAgICBza3Q6c2VuZCAoc3RyaW5nLmZvcm1hdCAoW1sKPCFET0NUWVBFIEhUTUwgUFVCTElDICItLy9JRVRGLy9EVEQgSFRNTCAyLjAvL0VOIj4KPEhUTUw+CjxIRUFEPgo8VElUTEU+NTAwIEludGVybmFsIFNlcnZlciBFcnJvcjwvVElUTEU+CjwvSEVBRD4KPEJPRFk+CjxIMT5JbnRlcm5hbCBTZXJ2ZXIgRXJyb3I8L0gxPgo8L0JPRFk+CjwvSFRNTD5dXSkpCmVuZAoKLS0gZ2V0cyBhbmQgcGFyc2VzIHRoZSByZXF1ZXN0IGxpbmUKLS0gcGFyYW1zOgotLSAgICAgICAgICAgICAgcmVxOiByZXF1ZXN0IG9iamVjdAotLSByZXR1cm5zOgotLSAgICAgICAgICAgICAgdHJ1ZSBpZiBvawotLSAgICAgICAgICAgICAgZmFsc2UgaWYgY29ubmVjdGlvbiBjbG9zZWQKLS0gc2V0czoKLS0gICAgICAgICAgICAgIHJlcS5jbWRfbXRoOiBodHRwIG1ldGhvZAotLSAgICAgICAgICAgICAgcmVxLmNtZF91cmw6IHVybCByZXF1ZXN0ZWQgKGFzIHNlbnQgYnkgdGhlIGNsaWVudCkKLS0gICAgICAgICAgICAgIHJlcS5jbWRfdmVyc2lvbjogaHR0cCB2ZXJzaW9uICh1c3VhbGx5ICdIVFRQLzEuMScpCmZ1bmN0aW9uIF9NLnJlYWRfbWV0aG9kIChyZXEpCiAgICBsb2NhbCBlcnIKICAgIHJlcS5jbWRsaW5lLCBlcnIgPSByZXEuc29ja2V0OnJlY2VpdmUgKCkKCiAgICBpZiBub3QgcmVxLmNtZGxpbmUgdGhlbiByZXR1cm4gbmlsIGVuZAogICAgcmVxLmNtZF9tdGgsIHJlcS5jbWRfdXJsLCByZXEuY21kX3ZlcnNpb24gPSB1bnBhY2sgKF9NLnN0cnNwbGl0IChyZXEuY21kbGluZSkpCiAgICByZXEuY21kX210aCA9IHN0cmluZy51cHBlciAocmVxLmNtZF9tdGggb3IgJ0dFVCcpCiAgICByZXEuY21kX3VybCA9IHJlcS5jbWRfdXJsIG9yICcvJwoKICAgIHJldHVybiB0cnVlCmVuZAoKLS0gZ2V0cyBhbmQgcGFyc2VzIHRoZSByZXF1ZXN0IGhlYWRlciBmaWVsZHMKLS0gcGFyYW1zOgotLSAgICAgICAgICAgICAgcmVxOiByZXF1ZXN0IG9iamVjdAotLSBzZXRzOgotLSAgICAgICAgICAgICAgcmVxLmhlYWRlcnM6IHRhYmxlIG9mIGhlYWRlciBmaWVsZHMsIGFzIG5hbWUgPT4gdmFsdWUKZnVuY3Rpb24gX00ucmVhZF9oZWFkZXJzIChyZXEpCiAgICBsb2NhbCBoZWFkZXJzID0ge30KICAgIGxvY2FsIHByZXZ2YWwsIHByZXZuYW1lCgogICAgd2hpbGUgMSBkbwogICAgICAgIGxvY2FsIGwsZXJyID0gcmVxLnNvY2tldDpyZWNlaXZlICgpCiAgICAgICAgaWYgKG5vdCBsIG9yIGwgPT0gIiIpIHRoZW4KICAgICAgICAgICAgcmVxLmhlYWRlcnMgPSBoZWFkZXJzCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGVuZAogICAgICAgIGxvY2FsIF8sXywgbmFtZSwgdmFsdWUgPSBzdHJpbmcuZmluZCAobCwgIl4oW146IF0rKSVzKjolcyooLispIikKICAgICAgICBuYW1lID0gc3RyaW5nLmxvd2VyIChuYW1lIG9yICcnKQogICAgICAgIGlmIG5hbWUgdGhlbgogICAgICAgICAgICBwcmV2dmFsID0gaGVhZGVycyBbbmFtZV0KICAgICAgICAgICAgaWYgcHJldnZhbCB0aGVuCiAgICAgICAgICAgICAgICB2YWx1ZSA9IHByZXZ2YWwgLi4gIiwiIC4uIHZhbHVlCiAgICAgICAgICAgIGVuZAogICAgICAgICAgICBoZWFkZXJzIFtuYW1lXSA9IHZhbHVlCiAgICAgICAgICAgIHByZXZuYW1lID0gbmFtZQogICAgICAgIGVsc2VpZiBwcmV2bmFtZSB0aGVuCiAgICAgICAgICAgIGhlYWRlcnMgW3ByZXZuYW1lXSA9IGhlYWRlcnMgW3ByZXZuYW1lXSAuLiBsCiAgICAgICAgZW5kCiAgICBlbmQKZW5kCgpmdW5jdGlvbiBfTS5yZWFkX2NvbnRlbnQocmVxKQogICAgbG9jYWwgc2l6ZSA9IHRvbnVtYmVyKHJlcS5oZWFkZXJzWyJjb250ZW50LWxlbmd0aCJdKQogICAgcmVxLmNvbnRlbnQgPSAiIgogICAgbG9jYWwgY2h1bmsgPSAxMDI0CiAgICB3aGlsZSBzaXplID4gMCBkbwogICAgICAgIGlmIChzaXplIDwgMTAyNCkgdGhlbiBjaHVuayA9IHNpemUgZW5kCiAgICAgICAgbG9jYWwgZGF0YSwgZXJyID0gcmVxLnNvY2tldDpyZWNlaXZlKGNodW5rKQogICAgICAgIGlmIChub3QgZGF0YSBvciBlcnIpIHRoZW4gYnJlYWsgZW5kCiAgICAgICAgc2l6ZSA9IHNpemUgLSBzdHJpbmcubGVuKGRhdGEpCiAgICAgICAgcmVxLmNvbnRlbnQgPSByZXEuY29udGVudCAuLiBkYXRhCiAgICBlbmQKZW5kCgpmdW5jdGlvbiBfTS5wYXJzZV91cmwgKHJlcSkKICAgIGxvY2FsIGRlZl91cmwgPSBzdHJpbmcuZm9ybWF0ICgiaHR0cDovLyVzJXMiLCByZXEuaGVhZGVycy5ob3N0IG9yICIiLCByZXEuY21kX3VybCBvciAiIikKCiAgICByZXEucGFyc2VkX3VybCA9IHVybC5wYXJzZSAoZGVmX3VybCBvciAnJykKICAgIHJlcS5wYXJzZWRfdXJsLnBvcnQgPSByZXEucGFyc2VkX3VybC5wb3J0IG9yIHJlcS5wb3J0CiAgICByZXEuYnVpbHRfdXJsID0gdXJsLmJ1aWxkIChyZXEucGFyc2VkX3VybCkKCiAgICByZXEucmVscGF0aCA9IHVybC51bmVzY2FwZSAocmVxLnBhcnNlZF91cmwucGF0aCkKZW5kCgotLSBzZXRzIHRoZSBkZWZhdWx0IHJlc3BvbnNlIGhlYWRlcnMKZnVuY3Rpb24gX00uZGVmYXVsdF9oZWFkZXJzIChyZXEpCiAgICByZXR1cm4gIHsKICAgICAgICBEYXRlID0gb3MuZGF0ZSAoIiElYSwgJWQgJWIgJVkgJUg6JU06JVMgR01UIiksCiAgICAgICAgU2VydmVyID0gX3NlcnZlcnNvZnR3YXJlLAogICAgfQplbmQKCmZ1bmN0aW9uIF9NLmFkZF9yZXNfaGVhZGVyIChyZXMsIGgsIHYpCiAgICBpZiBzdHJpbmcubG93ZXIoaCkgPT0gInN0YXR1cyIgdGhlbgogICAgICAgIHJlcy5zdGF0dXNsaW5lID0gIkhUVFAvMS4xICIuLnYKICAgIGVsc2UKICAgICAgICBsb2NhbCBwcmV2dmFsID0gcmVzLmhlYWRlcnMgW2hdCiAgICAgICAgaWYgKHByZXZ2YWwgID09IG5pbCkgdGhlbgogICAgICAgICAgICByZXMuaGVhZGVyc1toXSA9IHYKICAgICAgICBlbHNlaWYgdHlwZSAocHJldnZhbCkgPT0gInRhYmxlIiB0aGVuCiAgICAgICAgICAgIHRhYmxlLmluc2VydCAocHJldnZhbCwgdikKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJlcy5oZWFkZXJzW2hdID0ge3ByZXZ2YWwsIHZ9CiAgICAgICAgZW5kCiAgICBlbmQKZW5kCgoKLS0gc2VuZHMgdGhlIHJlc3BvbnNlIGhlYWRlcnMKLS0gcGFyYW1zOgotLSAgICAgICAgICAgICAgcmVzOiByZXNwb25zZSBvYmplY3QKLS0gdXNlczoKLS0gICAgICAgICAgICAgIHJlcy5zZW50X2hlYWRlcnMgOiBpZiB0cnVlLCBoZWFkZXJzIGFyZSBhbHJlYWR5IHNlbnQsIGRvZXMgbm90aGluZwotLSAgICAgICAgICAgICAgcmVzLnN0YXR1c2xpbmUgOiByZXNwb25zZSBzdGF0dXMsIGlmIG5pbCwgc2VuZHMgMjAwIE9LCi0tICAgICAgICAgICAgICByZXMuaGVhZGVycyA6IHRhYmxlIG9mIGhlYWRlciBmaWVsZHMgdG8gc2VuZApsb2NhbCBmdW5jdGlvbiBzZW5kX3Jlc19oZWFkZXJzIChyZXMpCiAgICBpZiAocmVzLnNlbnRfaGVhZGVycykgdGhlbgogICAgICAgIHJldHVybgogICAgZW5kCgogICAgLS1pZiBwYWNrYWdlLmxvYWRlZFsiaHR0cGQuY29va2llcyJdIHRoZW4KICAgIC0tICAgIGxvY2FsIGNvb2tpZXMgPSByZXF1aXJlICJodHRwZC5jb29raWVzIgogICAgLS0gICAgY29va2llcy5zZXRfcmVzX2Nvb2tpZXMgKHJlcykKICAgIC0tZW5kCgogICAgcmVzLnN0YXR1c2xpbmUgPSByZXMuc3RhdHVzbGluZSBvciAiSFRUUC8xLjEgMjAwIE9LIgoKICAgIHJlcy5zb2NrZXQ6c2VuZCAocmVzLnN0YXR1c2xpbmUuLiJcclxuIikKICAgIGZvciBuYW1lLCB2YWx1ZSBpbiBwYWlycyAocmVzLmhlYWRlcnMpIGRvCiAgICAgICAgaWYgdHlwZSh2YWx1ZSkgPT0gInRhYmxlIiB0aGVuCiAgICAgICAgICAgIGZvciBfLCB2YWx1ZSBpbiBpcGFpcnModmFsdWUpIGRvCiAgICAgICAgICAgICAgICByZXMuc29ja2V0OnNlbmQgKHN0cmluZy5mb3JtYXQgKCIlczogJXNcclxuIiwgbmFtZSwgdmFsdWUpKQogICAgICAgICAgICBlbmQKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJlcy5zb2NrZXQ6c2VuZCAoc3RyaW5nLmZvcm1hdCAoIiVzOiAlc1xyXG4iLCBuYW1lLCB2YWx1ZSkpCiAgICAgICAgZW5kCiAgICBlbmQKICAgIHJlcy5zb2NrZXQ6c2VuZCAoIlxyXG4iKQoKICAgIHJlcy5zZW50X2hlYWRlcnMgPSB0cnVlOwplbmQKCi0tIHNlbmRzIGNvbnRlbnQgZGlyZWN0bHkgdG8gY2xpZW50Ci0tICAgICAgICAgICAgICBzZW5kcyBoZWFkZXJzIGZpcnN0LCBpZiBuZWNlc2FyeQotLSBwYXJhbXM6Ci0tICAgICAgICAgICAgICByZXMgOyByZXNwb25zZSBvYmplY3QKLS0gICAgICAgICAgICAgIGRhdGEgOiBjb250ZW50IGRhdGEgdG8gc2VuZApsb2NhbCBmdW5jdGlvbiBzZW5kX3Jlc19kYXRhIChyZXMsIGRhdGEpCgogICAgaWYgbm90IHJlcy5zZW50X2hlYWRlcnMgdGhlbgogICAgICAgIHNlbmRfcmVzX2hlYWRlcnMgKHJlcykKICAgIGVuZAoKICAgIGlmIG5vdCBkYXRhIG9yIGRhdGEgPT0gIiIgdGhlbgogICAgICAgIHJldHVybgogICAgZW5kCgogICAgaWYgZGF0YSB0aGVuCiAgICAgICAgaWYgcmVzLmNodW5rZWQgdGhlbgogICAgICAgICAgICByZXMuc29ja2V0OnNlbmQgKHN0cmluZy5mb3JtYXQgKCIlWFxyXG4iLCBzdHJpbmcubGVuIChkYXRhKSkpCiAgICAgICAgICAgIHJlcy5zb2NrZXQ6c2VuZCAoZGF0YSkKICAgICAgICAgICAgcmVzLnNvY2tldDpzZW5kICgiXHJcbiIpCiAgICAgICAgZWxzZQogICAgICAgICAgICByZXMuc29ja2V0OnNlbmQgKGRhdGEpCiAgICAgICAgZW5kCiAgICBlbmQKZW5kCgpmdW5jdGlvbiBfTS5tYWtlX3Jlc3BvbnNlIChyZXEpCiAgICBsb2NhbCByZXMgPSB7CiAgICAgICAgcmVxID0gcmVxLAogICAgICAgIHNvY2tldCA9IHJlcS5zb2NrZXQsCiAgICAgICAgaGVhZGVycyA9IF9NLmRlZmF1bHRfaGVhZGVycyAocmVxKSwKICAgICAgICBhZGRfaGVhZGVyID0gX00uYWRkX3Jlc19oZWFkZXIsCiAgICAgICAgc2VuZF9oZWFkZXJzID0gc2VuZF9yZXNfaGVhZGVycywKICAgICAgICBzZW5kX2RhdGEgPSBzZW5kX3Jlc19kYXRhLAogICAgfQoKICAgIHJldHVybiByZXMKZW5kCgotLSBzZW5kcyBwcmVidWlsdCBjb250ZW50IHRvIHRoZSBjbGllbnQKLS0gICAgICAgICAgICAgIGlmIHBvc3NpYmxlLCBzZXRzIENvbnRlbnQtTGVuZ3RoOiBoZWFkZXIgZmllbGQKLS0gcGFyYW1zOgotLSAgICAgICAgICAgICAgcmVxIDogcmVxdWVzdCBvYmplY3QKLS0gICAgICAgICAgICAgIHJlcyA6IHJlc3BvbnNlIG9iamVjdAotLSB1c2VzOgotLSAgICAgICAgICAgICAgcmVzLmNvbnRlbnQgOiBjb250ZW50IGRhdGEgdG8gc2VuZAotLSBzZXRzOgotLSAgICAgICAgICAgICAgcmVzLmtlZXBfYWxpdmUgOiBpZiBwb3NzaWJsZSB0byBrZWVwIHVzaW5nIHRoZSBzYW1lIGNvbm5lY3Rpb24KZnVuY3Rpb24gX00uc2VuZF9yZXNwb25zZSAocmVxLCByZXMpCgogICAgaWYgcmVzLmNvbnRlbnQgdGhlbgogICAgICAgIGlmIG5vdCByZXMuc2VudF9oZWFkZXJzIHRoZW4KICAgICAgICAgICAgaWYgKHR5cGUgKHJlcy5jb250ZW50KSA9PSAidGFibGUiIGFuZCBub3QgcmVzLmNodW5rZWQpIHRoZW4KICAgICAgICAgICAgICAgIHJlcy5jb250ZW50ID0gdGFibGUuY29uY2F0IChyZXMuY29udGVudCkKICAgICAgICAgICAgZW5kCiAgICAgICAgICAgIGlmIHR5cGUgKHJlcy5jb250ZW50KSA9PSAic3RyaW5nIiB0aGVuCiAgICAgICAgICAgICAgICByZXMuaGVhZGVyc1siQ29udGVudC1MZW5ndGgiXSA9IHN0cmluZy5sZW4gKHJlcy5jb250ZW50KQogICAgICAgICAgICBlbmQKICAgICAgICBlbmQKICAgIGVsc2UKICAgICAgICBpZiBub3QgcmVzLnNlbnRfaGVhZGVycyB0aGVuCiAgICAgICAgICAgIHJlcy5zdGF0dXNsaW5lID0gIkhUVFAvMS4xIDIwNCBObyBDb250ZW50IgogICAgICAgICAgICByZXMuaGVhZGVyc1siQ29udGVudC1MZW5ndGgiXSA9IDAKICAgICAgICBlbmQKICAgIGVuZAoKICAgIGlmIHJlcy5jaHVua2VkIHRoZW4KICAgICAgICByZXM6YWRkX2hlYWRlciAoIlRyYW5zZmVyLUVuY29kaW5nIiwgImNodW5rZWQiKQogICAgZW5kCgogICAgaWYgcmVzLmNodW5rZWQgb3IgKChyZXMuaGVhZGVycyBbIkNvbnRlbnQtTGVuZ3RoIl0pIGFuZCBzdHJpbmcubG93ZXIgKHJlcS5oZWFkZXJzIFsiY29ubmVjdGlvbiJdIG9yICIiKSA9PSAia2VlcC1hbGl2ZSIpCiAgICB0aGVuCiAgICAgICAgcmVzLmhlYWRlcnMgWyJDb25uZWN0aW9uIl0gPSAiS2VlcC1BbGl2ZSIKICAgICAgICByZXMua2VlcF9hbGl2ZSA9IHRydWUKICAgIGVsc2UKICAgICAgICByZXMua2VlcF9hbGl2ZSA9IG5pbAogICAgZW5kCgogICAgaWYgcmVzLmNvbnRlbnQgdGhlbgogICAgICAgIGlmIHR5cGUgKHJlcy5jb250ZW50KSA9PSAidGFibGUiIHRoZW4KICAgICAgICAgICAgZm9yIF8sdiBpbiBpcGFpcnMgKHJlcy5jb250ZW50KSBkbyByZXM6c2VuZF9kYXRhICh2KSBlbmQKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJlczpzZW5kX2RhdGEgKHJlcy5jb250ZW50KQogICAgICAgIGVuZAogICAgZWxzZQogICAgICAgIHJlczpzZW5kX2hlYWRlcnMgKCkKICAgIGVuZAoKICAgIGlmIHJlcy5jaHVua2VkIHRoZW4KICAgICAgICByZXMuc29ja2V0OnNlbmQgKCIwXHJcblxyXG4iKQogICAgZW5kCmVuZAoKZnVuY3Rpb24gX00uZ2V0cGFyYW1zIChyZXEpCiAgICBpZiBub3QgcmVxLnBhcnNlZF91cmwucXVlcnkgdGhlbiByZXR1cm4gbmlsIGVuZAogICAgaWYgcmVxLnBhcmFtcyB0aGVuIHJldHVybiByZXEucGFyYW1zIGVuZAoKICAgIGxvY2FsIHBhcmFtcyA9IHt9CiAgICByZXEucGFyYW1zID0gcGFyYW1zCgogICAgZm9yIHBhcm0gaW4gc3RyaW5nLmdtYXRjaCAocmVxLnBhcnNlZF91cmwucXVlcnksICIoW14mXSspIikgZG8KICAgICAgICBsb2NhbCBrLHYgPSBzdHJpbmcubWF0Y2ggKHBhcm0sICIoLiopPSguKikiKQogICAgICAgIGsgPSB1cmwudW5lc2NhcGUgKGspCiAgICAgICAgdiA9IHVybC51bmVzY2FwZSAodikKICAgICAgICBpZiBrIH49IG5pbCB0aGVuCiAgICAgICAgICAgIGlmIHBhcmFtc1trXSA9PSBuaWwgdGhlbgogICAgICAgICAgICAgICAgcGFyYW1zW2tdID0gdgogICAgICAgICAgICBlbHNlaWYgdHlwZSAocGFyYW1zW2tdKSA9PSAidGFibGUiIHRoZW4KICAgICAgICAgICAgICAgIHRhYmxlLmluc2VydCAocGFyYW1zW2tdLCB2KQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICBwYXJhbXNba10gPSB7cGFyYW1zW2tdLCB2fQogICAgICAgICAgICBlbmQKICAgICAgICBlbmQKICAgIGVuZAoKICAgIHJldHVybiBwYXJhbXMKZW5kCgpmdW5jdGlvbiBfTS5lcnJfNDAwIChyZXEsIHJlcykKICAgIHJlcy5zdGF0dXNsaW5lID0gIkhUVFAvMS4xIDQwMCBCYWQgUmVxdWVzdCIKICAgIHJlcy5oZWFkZXJzIFsiQ29udGVudC1UeXBlIl0gPSAidGV4dC9odG1sIgogICAgcmVzLmNvbnRlbnQgPSBzdHJpbmcuZm9ybWF0IChbWwo8IURPQ1RZUEUgSFRNTCBQVUJMSUMgIi0vL0lFVEYvL0RURCBIVE1MIDIuMC8vRU4iPgo8SFRNTD4KPEhFQUQ+CjxUSVRMRT40MDAgQmFkIFJlcXVlc3Q8L1RJVExFPgo8L0hFQUQ+CjxCT0RZPgo8SDE+QmFkIFJlcXVlc3Q8L0gxPgo8L0JPRFk+CjwvSFRNTD5dXSk7CiAgICByZXR1cm4gcmVzCmVuZAoKZnVuY3Rpb24gX00uZXJyXzQwMyAocmVxLCByZXMpCiAgICByZXMuc3RhdHVzbGluZSA9ICJIVFRQLzEuMSA0MDMgRm9yYmlkZGVuIgogICAgcmVzLmhlYWRlcnMgWyJDb250ZW50LVR5cGUiXSA9ICJ0ZXh0L2h0bWwiCiAgICByZXMuY29udGVudCA9IHN0cmluZy5mb3JtYXQgKFtbCjwhRE9DVFlQRSBIVE1MIFBVQkxJQyAiLS8vSUVURi8vRFREIEhUTUwgMi4wLy9FTiI+CjxIVE1MPgo8SEVBRD4KPFRJVExFPjQwMyBGb3JiaWRkZW48L1RJVExFPgo8L0hFQUQ+CjxCT0RZPgo8SDE+Rm9yYmlkZGVuPC9IMT4KPC9CT0RZPgo8L0hUTUw+XV0pOwogICAgcmV0dXJuIHJlcwplbmQKCmZ1bmN0aW9uIF9NLmVycl80MDQgKHJlcSwgcmVzKQogICAgcmVzLnN0YXR1c2xpbmUgPSAiSFRUUC8xLjEgNDA0IE5vdCBGb3VuZCIKICAgIHJlcy5oZWFkZXJzIFsiQ29udGVudC1UeXBlIl0gPSAidGV4dC9odG1sIgogICAgcmVzLmNvbnRlbnQgPSBzdHJpbmcuZm9ybWF0IChbWwo8IURPQ1RZUEUgSFRNTCBQVUJMSUMgIi0vL0lFVEYvL0RURCBIVE1MIDIuMC8vRU4iPgo8SFRNTD4KPEhFQUQ+CjxUSVRMRT40MDQgTm90IEZvdW5kPC9USVRMRT4KPC9IRUFEPgo8Qk9EWT4KPEgxPk5vdCBGb3VuZDwvSDE+CjwvQk9EWT4KPC9IVE1MPl1dKTsKICAgIHJldHVybiByZXMKZW5kCgpmdW5jdGlvbiBfTS5lcnJfNDA1IChyZXEsIHJlcykKICAgIHJlcy5zdGF0dXNsaW5lID0gIkhUVFAvMS4xIDQwNSBNZXRob2QgTm90IEFsbG93ZWQiCiAgICByZXMuY29udGVudCA9IHN0cmluZy5mb3JtYXQgKFtbCjwhRE9DVFlQRSBIVE1MIFBVQkxJQyAiLS8vSUVURi8vRFREIEhUTUwgMi4wLy9FTiI+CjxIVE1MPgo8SEVBRD4KPFRJVExFPjQwNSBNZXRob2QgTm90IEFsbG93ZWQ8L1RJVExFPgo8L0hFQUQ+CjxCT0RZPgo8SDE+TWV0aG9kIE5vdCBBbGxvd2VkPC9IMT4KPC9CT0RZPgo8L0hUTUw+XV0pOwogICAgcmV0dXJuIHJlcwplbmQKCmZ1bmN0aW9uIF9NLmVycl81MDAgKHJlcSwgcmVzKQogICAgcmVzLnN0YXR1c2xpbmUgPSAiSFRUUC8xLjEgNTAwIEludGVybmFsIFNlcnZlciBFcnJvciIKICAgIHJlcy5jb250ZW50ID0gc3RyaW5nLmZvcm1hdCAoW1sKPCFET0NUWVBFIEhUTUwgUFVCTElDICItLy9JRVRGLy9EVEQgSFRNTCAyLjAvL0VOIj4KPEhUTUw+CjxIRUFEPgo8VElUTEU+NTAwIEludGVybmFsIFNlcnZlciBFcnJvcjwvVElUTEU+CjwvSEVBRD4KPEJPRFk+CjxIMT5JbnRlcm5hbCBTZXJ2ZXIgRXJyb3I8L0gxPgo8L0JPRFk+CjwvSFRNTD5dXSk7CiAgICByZXR1cm4gcmVzCmVuZAoKZnVuY3Rpb24gX00ucmVkaXJlY3QgKHJlcywgZCkKICAgIHJlcy5oZWFkZXJzIFsiTG9jYXRpb24iXSA9IGQKICAgIHJlcy5zdGF0dXNsaW5lID0gIkhUVFAvMS4xIDMwMiBGb3VuZCIKICAgIHJlcy5jb250ZW50ID0gInJlZGlyZWN0IgplbmQKCmZ1bmN0aW9uIF9NLnJlZ2lzdGVyIChob3N0LCBwb3J0LCBzZXJ2ZXJzb2Z0d2FyZSkKICAgIGxvY2FsIF9zZXJ2ZXIgPSBhc3NlcnQoc29ja2V0LmJpbmQoaG9zdCwgcG9ydCkpCiAgICBfc2VydmVyc29mdHdhcmUgPSBzZXJ2ZXJzb2Z0d2FyZQogICAgbG9jYWwgX2lwLCBfcG9ydCA9IF9zZXJ2ZXI6Z2V0c29ja25hbWUoKQogICAgaWYgX2lwID09ICIwLjAuMC4wIiB0aGVuCiAgICAgICAgX2lwID0gIjEyNy4wLjAuMSIKICAgIGVuZAogICAgdGFibGUuaW5zZXJ0KF9zZXJ2ZXJpcHMsIF9pcCkKICAgIHRhYmxlLmluc2VydChfc2VydmVycG9ydHMsIF9wb3J0KQogICAgX3NlcnZlcnBvcnRzW19wb3J0XSA9IHRydWUKICAgIGNvcGFzLmFkZHNlcnZlcihfc2VydmVyLCBfTS5jb25uZWN0aW9uKQplbmQKCmZ1bmN0aW9uIF9NLmdldF9wb3J0cygpCiAgICByZXR1cm4gX3NlcnZlcnBvcnRzCmVuZAoKZnVuY3Rpb24gX00uZ2V0X2lwcygpCiAgICByZXR1cm4gX3NlcnZlcmlwcwplbmQKCnJldHVybiBfTQ==";

#endif //MOONSHINE_TESTS_SERVER_SCRIPTS_H_
